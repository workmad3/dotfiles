function switch-docker {
  case "$1" in
  system)
    eval $(docker-machine env --unset)
    ;;
  *)
    eval $(docker-machine env "${1}")
    ;;
  esac
}

function cleanup-images {
  docker rmi $(docker images -aq | uniq)
}

function cleanup-containers {
  docker rm $(docker ps -aqf exited=0)
}

function current-docker-machine {
  echo -n ${DOCKER_MACHINE_NAME:-system}
}

function switch-docker-pwd {
  if [ -e "Dockerfile" ]; then
    local NEW_MACHINE_NAME=$(PWD | grep -o '[A-Za-z0-9\-]*$')
    if [ "$DOCKER_MACHINE_NAME" = "$NEW_MACHINE_NAME" ]; then
      true
    elif docker-machine env $NEW_MACHINE_NAME &> /dev/null; then
      switch-docker $NEW_MACHINE_NAME
    else
      switch-docker system
    fi
  elif ! [ -z "$DOCKER_MACHINE_NAME" ]; then
    switch-docker system
  fi
}

if [[ ! "$preexec_functions" == *switch-docker-pwd* ]]; then
  preexec_functions+=("switch-docker-pwd")
fi
